<?xml version="1.0"?>

<!-- 
NOT WORKING


Client-side code is compiled by using GWTCompiler which compiles client-side Java code into
JavaScript. Generated files are located under WebContent/VAADIN/widgetsets/*.

Client-side compilation is required if you use other widgets than the one included in the 
core Vaadin package (DefaultWidgetset). This is an example script for compiling the widgetset
and include any widgetset found in Vaadin addon jar files in your project.

-->

<project name="Widgetset compile example" basedir="." default="zipped-addon">
	<property name="cards-version" value="0.3.2" />
	<target name="zipped-addon">
		<zip destfile="builds/playingcards-${cards-version}.zip">
			<zipfileset dir="WebContent/META-INF" includes="MANIFEST.MF" prefix="META-INF" />
			<zipfileset dir="builds" includes="playingcards-${cards-version}.jar" />
			<zipfileset dir="doc" prefix="doc" />

		</zip>
	</target>

	<!-- 
		Update based on your project structure, by default this buildfile assumes that
		1. build.xml is in a "build" folder in the root of your project
		2. You are using Vaadin 6.2.1 and the jar file is in WebContent/WEB-INF/lib in your project
		3. The project source folder is "src"
		4. 
		1. use WebContent under your project's root directory
		2. WebContent/WEB-INF/lib/vaadin-6.2.1.jar exists
		3. WebContent/WEB-INF/src contains your project source files
		4. gwt directory contains extracted GWT distribution for your platform (windows, linux or mac)
	-->

	<!-- Configuration for the widget set-->

	<!-- Name of the widget set -->
	<property name="widgetset" value="org.vaadin.artur.playingcards.PlayingCardsWidgetset" />

	<!-- Path from this file to the root of your project -->
	<property name="base" value="." />

	<!-- where GWT distribution (gwt-dev.jar, gwt-user.jar) is located -->
	<property name="gwt-location" value="${base}/gwt" />

	<!-- where Vaadin jar is located -->
	<property name="vaadin-jar-location" location="${base}/WebContent/WEB-INF/lib/" />

	<!-- where project client-side widgetset source files are located -->
	<property name="src-location" location="${base}/src" />

	<!-- where to compile server-side classes -->
	<property name="server-side-destination" location="${base}/WebContent/WEB-INF/classes" />

	<!-- where to generate compiled javascript and theme files -->
	<property name="client-side-destination" location="${base}/WebContent/VAADIN/widgetsets" />

	<!-- Define if the widget set (widgetset.gwt.xml) should be generated automatically from all widget sets (jar files) included in the class path.    -->
	<property name="generate.widgetset" value="1" />

	<!-- Packaging configuration -->

	<!-- Title of the widget set (for JAR) -->
	<property name="widgetset-title" value="PlayingCards" />

	<!-- Version of the widget set (for JAR) -->
	<property name="widgetset-version" value="${cards-version}" />

	<!-- Vendor of the widget set (for JAR) -->
	<property name="widgetset-vendor" value="Artur Signell" />

	<!-- The compiled JAR name -->
	<property name="addon.destination" value="${base}/${widgetset-title}-${widgetset-version}.jar" />


	<!-- Path to the widgetset directory. Required only for generated widget sets. -->
	<!-- Must be relative to $src-location, that is, under the first entry in class path. -->
	<property name="widgetset-path" value="com/vaadin/demo/widgetset" />

	<!-- ================================================== -->
	<!-- Build Targets                                      -->
	<!-- ================================================== -->

	<target name="init">

		<echo>Using classpath:</echo>
		<echo>  ${gwt-location}/gwt-dev.jar</echo>
		<echo>  ${gwt-location}/gwt-user.jar</echo>
		<echo>  ${vaadin-jar-location}/vaadin-*.jar</echo>
		<echo>To compile source folder:</echo>
		<echo>  ${src-location}</echo>
		<echo>Output will be written into ${client-side-destination}</echo>

		<!-- Check that files exist -->
		<fail message="Some of the required files (listed above) are missing.">
			<condition>
				<not>
					<resourcecount count="3">
						<filelist files="${gwt-location}/gwt-dev-*.jar,${gwt-location}/gwt-user.jar,${vaadin-jar-location}/vaadin-*.jar" />
					</resourcecount>
				</not>
			</condition>
		</fail>

		<!-- Construct and check classpath -->
		<!-- Includes paths required for both server and client-side compilation -->
		<path id="compile.classpath">
			<!-- The source location must be first, as required by generate-widgetset. -->
			<pathelement path="${src-location}" />
			<pathelement path="${server-side-destination}" />
			<pathelement path="${vaadin-jar-location}" />
			<pathelement path="${gwt-location}/gwt-user.jar" />
			<pathelement path="${gwt-location}/gwt-dev-${gwt-platform}.jar" />
			<fileset dir="${base}/WebContent/WEB-INF/lib/">
				<include name="*.jar" />
			</fileset>
		</path>
	</target>

	<!-- Compiled server-side components are needed for building the client-side -->
	<target name="compile-server-side" depends="init">
		<mkdir dir="${server-side-destination}" />
		<javac srcdir="${src-location}" destdir="${server-side-destination}">
			<classpath>
				<path refid="compile.classpath" />
			</classpath>
		</javac>
	</target>

	<!-- Generates a combined widget set from all widget    -->
	<!-- sets in the class path, including project sources. -->
	<!-- Updates the configuration if it already exists.    -->
	<target name="generate-widgetset" depends="compile-server-side" if="generate.widgetset">

		<!-- Create the directory if it does not already exist. -->
		<mkdir dir="${src-location}/${widgetset-path}" />

		<java classname="com.vaadin.terminal.gwt.widgetsetutils.WidgetSetBuilder" failonerror="yes" fork="yes" maxmemory="256m">
			<arg value="${widgetset}" />
			<jvmarg value="-Xss1024k" />
			<jvmarg value="-Djava.awt.headless=true" />
			<classpath>
				<path refid="compile.classpath" />
			</classpath>
		</java>
	</target>

	<!-- Build the widget set. -->
	<target name="compile-widgetset" depends="compile-server-side, generate-widgetset">
		<echo>Compiling ${widgetset}...</echo>

		<java classname="com.google.gwt.dev.Compiler" failonerror="yes" fork="yes" maxmemory="256m">
			<arg value="-war" />
			<arg value="${client-side-destination}" />
			<arg value="${widgetset}" />
			<jvmarg value="-Xss1024k" />
			<jvmarg value="-Djava.awt.headless=true" />
			<classpath>
				<path refid="compile.classpath" />
			</classpath>
		</java>
	</target>

	<!-- Build JAR -->
	<target name="package-jar" depends="init">
		<jar jarfile="${jar-destination}" compress="true">
			<manifest>
				<attribute name="Vaadin-Package-Version" value="1" />
				<attribute name="Vaadin-Widgetsets" value="${widgetset}" />
				<attribute name="Implementation-Title" value="${widgetset-title}" />
				<attribute name="Implementation-Version" value="${widgetset-version}" />
				<attribute name="Implementation-Vendor" value="${widgetset-vendor}" />

			</manifest>

			<!-- The built server-side classes are here. -->
			<fileset dir="${server-side-destination}">
				<patternset>
					<include name="**/*" />
				</patternset>
			</fileset>

			<!-- Especially all the widget set source files are required. -->
			<fileset dir="${src-location}">
				<patternset>
					<include name="**/*" />
				</patternset>
			</fileset>
		</jar>
	</target>
</project>
